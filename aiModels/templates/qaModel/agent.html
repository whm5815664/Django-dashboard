{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä½“åŠ©æ‰‹</title>
    <style>
        /* ========== å¼¹çª—é®ç½©å±‚ ========== */
        .agent-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .agent-modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ========== å¼¹çª—å®¹å™¨ï¼ˆç™½è‰²å®¢æœé£æ ¼ï¼Œå°å°ºå¯¸ï¼‰ ========== */
        .agent-modal-container {
            width: 100%;
            height: 100%;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            animation: slideUp 0.25s ease;
            border: 1px solid #e5e7eb;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ========== å¼¹çª—å¤´éƒ¨ ========== */
        .agent-modal-header {
            padding: 12px 14px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #ffffff;
        }

        .agent-modal-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            font-weight: 700;
            color: #111827;
        }

        .agent-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f3f4f6;
            color: #111827;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .agent-modal-close:hover {
            background: #e5e7eb;
            transform: rotate(90deg);
        }

        /* ========== èŠå¤©å®¹å™¨ ========== */
        .agent-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* ========== æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ ========== */
        .agent-chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f9fafb;
        }

        .agent-chat-box::-webkit-scrollbar {
            width: 6px;
        }

        .agent-chat-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .agent-chat-box::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .agent-chat-box::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ========== æ¶ˆæ¯æ ·å¼ ========== */
        .agent-message {
            display: flex;
            gap: 10px;
            animation: messageSlideIn 0.3s ease-out;
            max-width: 90%;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .agent-message.user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .agent-message.bot-message {
            align-self: flex-start;
        }

        .agent-message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            background: #e5e7eb;
            color: #111827;
        }

        .agent-message-content {
            padding: 10px 12px;
            border-radius: 10px;
            line-height: 1.55;
            word-wrap: break-word;
            white-space: pre-wrap;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #111827;
            font-size: 12px;
        }

        .agent-user-message .agent-message-content {
            background: #eef2ff;
            border-color: #e0e7ff;
            border-bottom-right-radius: 4px;
        }

        .agent-bot-message .agent-message-content {
            background: #ffffff;
            border-color: #e5e7eb;
            border-bottom-left-radius: 4px;
        }

        .agent-bot-content {
            color: #111827;
        }

        .agent-bot-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .agent-bot-content pre {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        /* ========== åŠ è½½åŠ¨ç”» ========== */
        .agent-loading-dots {
            display: inline-block;
        }

        .agent-loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* ========== è¾“å…¥åŒºåŸŸ ========== */
        .agent-input-area {
            padding: 10px 12px;
            border-top: 1px solid #e5e7eb;
            background: #ffffff;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            font-size: 12px;
        }

        .agent-input-wrapper {
            flex: 1;
            position: relative;
            min-width: 0; /* å…³é”®ï¼šå…è®¸åœ¨å°çª—å†…æ”¶ç¼©ï¼Œé¿å…é®æŒ¡æŒ‰é’® */
        }

        .agent-question-input {
            width: 100%;
            padding: 9px 11px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            color: #111827;
            font-size: 12px;
            outline: none;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .agent-question-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
            background: #ffffff;
        }

        .agent-question-input::placeholder {
            color: #9ca3af;
        }

        .agent-send-btn {
            padding: 9px 14px;
            background: #6366f1;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        .agent-send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
        }

        .agent-send-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .agent-clear-btn {
            padding: 9px 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            color: #374151;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .agent-clear-btn:hover {
            background: #e5e7eb;
        }

        /* ========== æ¬¢è¿æ¶ˆæ¯ ========== */
        .agent-welcome-message {
            text-align: left;
            padding: 6px 2px;
            color: #4b5563;
        }

        .agent-welcome-message p {
            margin: 4px 0;
            font-size: 12px;
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 768px) {
            .agent-modal-container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .agent-message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <style>
        /* æ›´å°çš„åŸºç¡€å­—å·ï¼ˆå®¢æœå°çª—æ›´ç´§å‡‘ï¼‰ */
        body { font-size: 12px; }
    </style>
    <!-- å¼¹çª—é®ç½©å±‚ -->
    <div id="agent-modal-overlay" class="agent-modal-overlay">
        <div class="agent-modal-container">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="agent-modal-header">
                <div class="agent-modal-title">
                    <span>ğŸ¤–</span>
                    <span>æ™ºèƒ½ä½“åŠ©æ‰‹</span>
                </div>
                <button class="agent-modal-close" onclick="closeAgentModal()">Ã—</button>
            </div>

            <!-- èŠå¤©å®¹å™¨ -->
            <div class="agent-chat-container">
                <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="agent-chat-box" id="agent-chat-box">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="agent-message agent-bot-message">
                        <div class="agent-message-avatar">ğŸ¤–</div>
                        <div class="agent-message-content agent-bot-content">
                            <div class="agent-welcome-message">
                                <p>ğŸŒ± æ¬¢è¿ä½¿ç”¨AIoTå®éªŒå®¤çš„å†œä¸šå¤§æ¨¡å‹é—®ç­”ç³»ç»Ÿï¼</p>
                                <p>ğŸ† ç³»ç»ŸåŸºäºDeepSeek-R1è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæµ‹è¯•ç‰ˆæœ¬0.3V</p>
                                <p>è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="agent-input-area">
                    <div class="agent-input-wrapper">
                        <input 
                            type="text" 
                            id="agent-question-input" 
                            class="agent-question-input" 
                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                            autocomplete="off"
                        >
                    </div>
                    <button class="agent-send-btn" id="agent-send-btn" onclick="sendAgentQuestion()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€å˜é‡ ==========
        let agentChatHistory = [];
        let isAgentProcessing = false;
        let currentAgentAbortController = null;

        // ========== å·¥å…·å‡½æ•° ==========
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            // ç®€å•çš„ Markdown æ ¼å¼åŒ–
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // ========== æ¶ˆæ¯ç®¡ç† ==========
        function addAgentMessage(role, content, messageId = null, isLoading = false) {
            const chatBox = document.getElementById('agent-chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = `agent-message ${role === 'user' ? 'agent-user-message' : 'agent-bot-message'}`;
            if (messageId) {
                messageDiv.id = messageId;
            }

            const avatar = document.createElement('div');
            avatar.className = 'agent-message-avatar';
            avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'agent-message-content';
            
            if (role === 'user') {
                contentDiv.textContent = content;
            } else {
                contentDiv.className += ' agent-bot-content';
                if (isLoading) {
                    contentDiv.innerHTML = content;
                } else {
                    contentDiv.innerHTML = formatResponse(escapeHtml(content));
                }
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatBox.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatBox.scrollTop = chatBox.scrollHeight;

            return messageDiv;
        }

        // ========== æ›´æ–°æ€è€ƒä¸­æ¶ˆæ¯ ==========
        function updateThinkingMessage(thinkingId, message) {
            const thinkingEl = document.getElementById(thinkingId);
            if (thinkingEl) {
                const contentDiv = thinkingEl.querySelector('.agent-message-content');
                if (contentDiv) {
                    contentDiv.innerHTML = message;
                }
            }
        }

        // ========== å‘é€é—®é¢˜ ==========
        function sendAgentQuestion() {
            const input = document.getElementById('agent-question-input');
            const question = input.value.trim();
            const sendBtn = document.getElementById('agent-send-btn');

            if (!question) {
                return;
            }

            if (isAgentProcessing) {
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addAgentMessage('user', question);
            input.value = '';
            sendBtn.disabled = true;

            // æ·»åŠ åŠ è½½ä¸­çš„æœºå™¨äººæ¶ˆæ¯
            const thinkingId = 'thinking-' + Date.now();
            addAgentMessage('bot', 'ğŸ¤” æ€è€ƒä¸­<span class="agent-loading-dots"></span>', thinkingId, true);

            isAgentProcessing = true;
            currentAgentAbortController = new AbortController();

            // ä½¿ç”¨EventSourceæ¥æ”¶SSEæµå¼å“åº”
            const apiEndpoint = '/aiModels/brain';
            const formData = new FormData();
            formData.append('question', question);
            
            // ç”±äºEventSourceä¸æ”¯æŒPOSTï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨fetchçš„æµå¼è¯»å–
            fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({
                    question: question
                }),
                signal: currentAgentAbortController.signal
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            return;
                        }
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    
                                    if (data.type === 'status') {
                                        // æ›´æ–°æ€è€ƒä¸­æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ­£åœ¨è°ƒç”¨çš„æ™ºèƒ½ä½“
                                        updateThinkingMessage(thinkingId, `ğŸ¤” ${data.message}<span class="agent-loading-dots"></span>`);
                                    } else if (data.type === 'result') {
                                        // å¤„ç†æœ€ç»ˆç»“æœ
                                        isAgentProcessing = false;
                                        sendBtn.disabled = false;
                                        
                                        // ç§»é™¤åŠ è½½ä¸­çš„æ¶ˆæ¯
                                        const thinkingEl = document.getElementById(thinkingId);
                                        if (thinkingEl) {
                                            thinkingEl.remove();
                                        }
                                        
                                        if (data.success && data.answer) {
                                            // æ·»åŠ æœºå™¨äººå›ç­”
                                            addAgentMessage('bot', data.answer);
                                            
                                            // æ›´æ–°èŠå¤©å†å²
                                            agentChatHistory.push({ role: 'user', content: question });
                                            agentChatHistory.push({ role: 'assistant', content: data.answer });
                                        } else {
                                            addAgentMessage('bot', 'âŒ è·å–å›ç­”å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                                        }
                                        return;
                                    } else if (data.type === 'error') {
                                        // å¤„ç†é”™è¯¯
                                        isAgentProcessing = false;
                                        sendBtn.disabled = false;
                                        
                                        const thinkingEl = document.getElementById(thinkingId);
                                        if (thinkingEl) {
                                            thinkingEl.remove();
                                        }
                                        
                                        addAgentMessage('bot', 'âŒ è·å–å›ç­”å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                                        return;
                                    }
                                } catch (e) {
                                    console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                                }
                            }
                        }
                        
                        readStream();
                    }).catch(error => {
                        if (error.name !== 'AbortError') {
                            isAgentProcessing = false;
                            sendBtn.disabled = false;
                            
                            const thinkingEl = document.getElementById(thinkingId);
                            if (thinkingEl) {
                                thinkingEl.remove();
                            }
                            
                            addAgentMessage('bot', 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
                        }
                    });
                }
                
                readStream();
            })
            .catch(error => {
                isAgentProcessing = false;
                sendBtn.disabled = false;

                // ç§»é™¤åŠ è½½ä¸­çš„æ¶ˆæ¯
                const thinkingEl = document.getElementById(thinkingId);
                if (thinkingEl) {
                    thinkingEl.remove();
                }

                if (error.name === 'AbortError') {
                    addAgentMessage('bot', 'â¹ è¯·æ±‚å·²å–æ¶ˆ');
                } else {
                    addAgentMessage('bot', 'âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
                }
            });
        }

        // ========== æ¸…ç©ºèŠå¤© ==========
        function resetAgentUIWithWelcome() {
            const chatBox = document.getElementById('agent-chat-box');
            if (!chatBox) return;
            chatBox.innerHTML = '';
            agentChatHistory = [];
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            addAgentMessage('bot', 'ğŸŒ± æ¬¢è¿ä½¿ç”¨AIoTå®éªŒå®¤çš„å†œä¸šå¤§æ¨¡å‹é—®ç­”ç³»ç»Ÿï¼\nğŸ† ç³»ç»ŸåŸºäºDeepSeek-R1è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæµ‹è¯•ç‰ˆæœ¬0.3V\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ');
        }

        async function clearAgentContextSilently() {
            try {
                await fetch('/aiModels/clear_chat_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    body: JSON.stringify({})
                });
            } catch (err) {
                console.warn('æ¸…ç©ºä¸Šä¸‹æ–‡è¯·æ±‚å¤±è´¥(å¿½ç•¥):', err);
            }
        }

        // ========== å¼¹çª—æ§åˆ¶ ==========
        function openAgentModal() {
            const overlay = document.getElementById('agent-modal-overlay');
            if (overlay) {
                overlay.classList.add('show');
                // âœ… æ¯æ¬¡æ‰“å¼€ï¼šè‡ªåŠ¨æ¸…ç©ºä¸Šä¸‹æ–‡ä¸ç•Œé¢
                resetAgentUIWithWelcome();
                clearAgentContextSilently();
                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    const input = document.getElementById('agent-question-input');
                    if (input) {
                        input.focus();
                    }
                }, 300);
            }
        }

        function closeAgentModal() {
            const overlay = document.getElementById('agent-modal-overlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
            // é€šçŸ¥çˆ¶é¡µé¢å¯ä»¥éšè— iframe
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'agent-close' }, '*');
                }
            } catch (e) {
                console.warn('postMessage å…³é—­æŒ‡ä»¤å¤±è´¥:', e);
            }
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        // å›è½¦é”®å‘é€
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('agent-question-input');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAgentQuestion();
                    }
                });
            }

            // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
            const overlay = document.getElementById('agent-modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeAgentModal();
                    }
                });
            }
        });

        // ========== å¯¼å‡ºå‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨ ==========
        window.openAgentModal = openAgentModal;
        window.closeAgentModal = closeAgentModal;
    </script>
</body>
</html>

