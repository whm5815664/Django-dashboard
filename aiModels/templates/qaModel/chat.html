{% load static %}
<!DOCTYPE html>
<html>
<head>
    <!-- é¡µé¢æ ‡é¢˜ -->
    <title>å†œä¸šå¤§æ¨¡å‹é—®ç­”ç³»ç»Ÿ</title>
    <!-- å­—ç¬¦ç¼–ç è®¾ç½® -->
    <meta charset="UTF-8">
    <!-- å“åº”å¼è®¾è®¡ï¼šç§»åŠ¨ç«¯é€‚é… -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ========== å…¨å±€æ ·å¼é‡ç½® ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ========== åŸºç¡€æ ·å¼ ========== */
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
            position: relative;
        }
        
        /* ========== èƒŒæ™¯åŠ¨ç”»æ•ˆæœ ========== */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ========== ä¸»å®¹å™¨æ ·å¼ ========== */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ========== é¡¶éƒ¨å¯¼èˆªæ  ========== */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ========== LOGOå®¹å™¨ ========== */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* ========== LOGOæ ·å¼ ========== */
        .logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(120, 219, 255, 0.5));
            transition: all 0.3s ease;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            backdrop-filter: blur(10px);
        }
        
        .logo:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 0 30px rgba(120, 219, 255, 0.8));
        }
        
        /* ========== ç³»ç»Ÿæ ‡é¢˜ ========== */
        .system-title {
            font-size: 1.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #78dfff, #ff77c6, #7877c6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(120, 219, 255, 0.5);
        }
        
        /* ========== èŠå¤©å®¹å™¨æ ·å¼ ========== */
        .chat-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            padding: 30px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(120, 219, 255, 0.5), transparent);
        }
        
        /* ========== èŠå¤©æ¡†æ ·å¼ ========== */
        .chat-box {
            flex: 1;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .chat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 48%, rgba(120, 219, 255, 0.03) 50%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, rgba(255, 119, 198, 0.03) 50%, transparent 52%);
            pointer-events: none;
        }
        
        /* ========== æ»šåŠ¨æ¡æ ·å¼ ========== */
        .chat-box::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .chat-box::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #78dfff, #ff77c6);
            border-radius: 3px;
        }
        
        .chat-box::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5acfff, #ff5ab6);
        }
        
        /* ========== æ¶ˆæ¯åŸºç¡€æ ·å¼ ========== */
        .message {
            margin-bottom: 20px;
            padding: 20px 25px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            animation: messageSlideIn 0.4s ease-out;
            backdrop-filter: blur(10px);
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* ========== ç”¨æˆ·æ¶ˆæ¯æ ·å¼ ========== */
        .user-message {
            background: linear-gradient(135deg, rgba(120, 219, 255, 0.2), rgba(120, 119, 198, 0.2));
            border: 1px solid rgba(120, 219, 255, 0.3);
            margin-left: auto;
            text-align: left;
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(120, 219, 255, 0.2);
        }
        
        .user-message::before {
            content: 'ğŸ‘¤';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(120, 219, 255, 0.8);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        /* ========== æœºå™¨äººæ¶ˆæ¯æ ·å¼ ========== */
        .bot-message {
            background: linear-gradient(135deg, rgba(255, 119, 198, 0.1), rgba(120, 119, 198, 0.1));
            border: 1px solid rgba(255, 119, 198, 0.2);
            margin-right: auto;
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 119, 198, 0.1);
        }
        
        .bot-message::before {
            content: '';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 119, 198, 0.8);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        /* ========== è¾“å…¥åŒºåŸŸæ ·å¼ ========== */
        .input-area {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        /* ========== é—®é¢˜è¾“å…¥æ¡†æ ·å¼ ========== */
        #question {
            flex-grow: 1;
            padding: 18px 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            transition: all 0.3s ease;
            outline: none;
            backdrop-filter: blur(10px);
        }
        
        #question:focus {
            border-color: rgba(120, 219, 255, 0.6);
            box-shadow: 0 0 20px rgba(120, 219, 255, 0.3);
            background: rgba(0, 0, 0, 0.4);
        }
        
        #question::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* ========== æŒ‰é’®åŸºç¡€æ ·å¼ ========== */
        button {
            padding: 18px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            outline: none;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        /* ========== å‘é€æŒ‰é’®æ ·å¼ ========== */
        #send-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000000;
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }
        
        #send-btn:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 255, 136, 0.4);
        }
        
        #send-btn:disabled {
            background: linear-gradient(135deg, #666666, #444444);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* ========== è¯­éŸ³æŒ‰é’®æ ·å¼ ========== */
        #voice-btn {
            background: linear-gradient(135deg, #78dfff, #5acfff);
            color: #000000;
            box-shadow: 0 8px 25px rgba(120, 219, 255, 0.3);
        }
        
        #voice-btn:hover {
            background: linear-gradient(135deg, #5acfff, #3abfff);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(120, 219, 255, 0.4);
        }
        
        #voice-btn.listening {
            background: linear-gradient(135deg, #ff77c6, #ff5ab6);
            animation: voicePulse 1.5s infinite;
        }
        
        #voice-btn.disabled {
            background: linear-gradient(135deg, #666666, #444444);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ========== å¼ºåˆ¶ç»“æŸæŒ‰é’®æ ·å¼ ========== */
        #stop-btn {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
            display: none;
        }
        
        #stop-btn:hover {
            background: linear-gradient(135deg, #ff3742, #ff2f3a);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 71, 87, 0.4);
        }
        
        #stop-btn::before {
            content: 'â¹';
            font-size: 16px;
            margin-right: 8px;
        }
        
        /* ========== å·¥å…·ç®±æŒ‰é’®æ ·å¼ ========== */
        #toolbox-btn {
            background: linear-gradient(135deg, #6c5ce7, #5f3dc4);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.3);
        }
        
        #toolbox-btn:hover {
            background: linear-gradient(135deg, #5f3dc4, #4c2db8);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(108, 92, 231, 0.4);
        }
        
        /* ========== æ€è€ƒä¸­çŠ¶æ€æ ·å¼ ========== */
        .thinking {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            animation: thinkingPulse 1.5s infinite;
        }
        
        @keyframes thinkingPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* ========== æ€ç»´é“¾å†…å®¹æ ·å¼ ========== */
        .reasoning {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin: 15px 0;
            padding: 20px;
            background: rgba(120, 119, 198, 0.1);
            border-left: 4px solid #7877c6;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        /* ========== æœºå™¨äººå›å¤å†…å®¹æ ¼å¼åŒ–æ ·å¼ ========== */
        .bot-content {
            white-space: pre-wrap;
        }
        
        .bot-content p {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        /* ========== æ¬¢è¿æ¶ˆæ¯ç‰¹æ®Šæ ·å¼ ========== */
        .welcome-message .bot-content p {
            margin: 6px 0;
            line-height: 1.4;
            font-size: 1.1em;
        }
        
        .welcome-message .bot-content p:first-child {
            margin-top: 0;
        }
        
        .welcome-message .bot-content p:last-child {
            margin-bottom: 0;
        }
        
        .bot-content pre {
            background: rgba(0, 0, 0, 0.4);
            color: #78dfff;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 16px 0;
            border-left: 4px solid #78dfff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .bot-content code {
            font-family: 'Fira Code', 'Courier New', monospace;
            background: rgba(120, 219, 255, 0.2);
            color: #78dfff;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .bot-content blockquote {
            border-left: 4px solid #ff77c6;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            margin: 16px 0;
            background: rgba(255, 119, 198, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .bot-content h1, .bot-content h2, .bot-content h3 {
            margin: 20px 0 12px;
            color: #ffffff;
            font-weight: 600;
        }
        
        .bot-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #78dfff;
            padding-bottom: 8px;
        }
        
        .bot-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 6px;
        }
        
        .separator {
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin: 20px 0;
            font-size: 0.9em;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
        }
        
        /* ========== å·¥å…·ç®±å¼¹çª—æ ·å¼ ========== */
        .toolbox-modal {
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .toolbox-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .toolbox-item {
            width: 100%;
        }
        
        .toolbox-action-btn {
            width: 100%;
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 16px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .toolbox-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .toolbox-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }
        
        .toolbox-text {
            flex: 1;
            text-align: left;
        }
        
        .toolbox-status {
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .toolbox-status.enabled {
            background: rgba(0, 184, 148, 0.3);
            border-color: rgba(0, 184, 148, 0.5);
            color: #00b894;
        }
        
        .toolbox-status.disabled {
            background: rgba(255, 71, 87, 0.3);
            border-color: rgba(255, 71, 87, 0.5);
            color: #ff4757;
        }
        
        /* ========== çŸ¥è¯†åº“å¢å¼ºæŒ‰é’®æ ·å¼ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰ ========== */
        #rag-toggle-btn {
            background: linear-gradient(135deg, #ff9f43, #ff8c42);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 159, 67, 0.3);
        }
        
        #rag-toggle-btn:hover {
            background: linear-gradient(135deg, #ff8c42, #ff7b3a);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 159, 67, 0.4);
        }
        
        #rag-toggle-btn.enabled {
            background: linear-gradient(135deg, #00b894, #00a085);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.3);
        }
        
        #rag-toggle-btn.enabled:hover {
            background: linear-gradient(135deg, #00a085, #008f7a);
            box-shadow: 0 12px 35px rgba(0, 184, 148, 0.4);
        }
        
        #rag-toggle-btn.loading {
            background: linear-gradient(135deg, #6c5ce7, #5f3dc4);
            animation: ragPulse 1.5s infinite;
        }
        
        @keyframes ragPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ========== æ¸…ç©ºä¸Šä¸‹æ–‡æŒ‰é’®æ ·å¼ ========== */
        #clear-context-btn {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
        }
        
        #clear-context-btn:hover {
            background: linear-gradient(135deg, #ff3742, #ff2f3a);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 71, 87, 0.4);
        }
        
        /* ========== çŸ¥è¯†åº“åŠ è½½å¼¹çª—æ ·å¼ ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            overflow: hidden;
        }
        
        .modal-body {
            padding: 30px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #78dfff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #rag-loading-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
            margin: 0;
        }
        
        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .top-nav {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .system-title {
                font-size: 1.4em;
            }
            
            .chat-container {
                padding: 20px;
                border-radius: 20px;
            }
            
            .chat-box {
                min-height: 400px;
                padding: 20px;
            }
            
            .input-area {
                flex-direction: column;
                gap: 12px;
            }
            
            button {
                width: 100%;
                padding: 16px 20px;
            }
            
            #question {
                padding: 16px 20px;
            }
        }
        
        /* ========== åŠ è½½åŠ¨ç”» ========== */
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '';
            animation: loadingDots 1.5s infinite;
        }
        
        @keyframes loadingDots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* ========== ç§‘æŠ€æ„Ÿè£…é¥°å…ƒç´  ========== */
        .tech-decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(120, 219, 255, 0.3);
            border-radius: 50%;
            animation: rotate 20s linear infinite;
        }
        
        .tech-decoration:nth-child(1) {
            top: 10%;
            right: 10%;
            animation-delay: 0s;
        }
        
        .tech-decoration:nth-child(2) {
            bottom: 20%;
            left: 5%;
            animation-delay: -10s;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ========== è¿”å›æŒ‰é’®æ ·å¼ ========== */
        .back-button {
            position: relative;
            z-index: 1000;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-decoration: none;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .back-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            color: #78dfff;
        }
        
        .back-link i {
            font-size: 16px;
        }

        /* ========== åœæ­¢ç¡®è®¤UIæ ·å¼ ========== */
        .stop-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            padding: 30px;
            text-align: center;
            z-index: 10001;
            backdrop-filter: blur(20px);
            min-width: 300px;
        }

        .stop-confirmation h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .stop-confirmation p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .voice-hint {
            color: rgba(120, 219, 255, 0.8) !important;
            font-size: 0.9em !important;
            margin-bottom: 20px !important;
            font-style: italic;
            animation: voiceHintPulse 2s infinite;
        }

        @keyframes voiceHintPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirmation-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            outline: none;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 80px;
        }

        .confirmation-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .confirmation-btn:hover::before {
            left: 100%;
        }

        .confirm-yes {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000000;
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .confirm-yes:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 255, 136, 0.4);
        }

        .confirm-no {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
        }

        .confirm-no:hover {
            background: linear-gradient(135deg, #ff3742, #ff2f3a);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 71, 87, 0.4);
        }

        .stop-confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <!-- ç§‘æŠ€æ„Ÿè£…é¥°å…ƒç´  -->
    <div class="tech-decoration"></div>
    <div class="tech-decoration"></div>
    
    <!-- ========== ä¸»å®¹å™¨ ========== -->
    <div class="main-container">
        <!-- ========== é¡¶éƒ¨å¯¼èˆªæ  ========== -->
        <div class="top-nav">
            <!-- LOGOå’Œæ ‡é¢˜å®¹å™¨ -->
            <div class="logo-container">
                <!-- AIoTå®éªŒå®¤LOGO -->
                <img src="{% static 'images/AIoTå®éªŒå®¤LOGO.png' %}" alt="AIoTå®éªŒå®¤" class="logo">
                <!-- ç³»ç»Ÿæ ‡é¢˜ -->
                <div class="system-title">å†œä¸šå¤§æ¨¡å‹é—®ç­”ç³»ç»Ÿ</div>
            </div>
            
            <!-- è¿”å›æŒ‰é’® -->
            <div class="back-button">
                <a href="javascript:history.back()" class="back-link">
                    <i class="fa fa-arrow-left"></i> è¿”å›
                </a>
            </div>
        </div>

        <!-- ========== èŠå¤©å®¹å™¨ ========== -->
        <div class="chat-container">
            <!-- èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="chat-box" id="chat-box">
                <!-- å†å²èŠå¤©è®°å½• -->
                {% if chat_history %}
                    {% for message in chat_history %}
                        {% if message.role == 'user' %}
                            <div class="message user-message">
                                <div>{{ message.content }}</div>
                            </div>
                        {% elif message.role == 'assistant' %}
                            <div class="message bot-message">
                                <div class="bot-content">{{ message.content|safe }}</div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <!-- å†å²è®°å½•åˆ†éš”çº¿ -->
                    <div class="separator">ğŸ“š å†å²å¯¹è¯è®°å½•</div>
                {% endif %}
                
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message bot-message welcome-message">
                    <div class="bot-content">
                        <p>ğŸŒ± æ¬¢è¿ä½¿ç”¨AIoTå®éªŒå®¤çš„å†œä¸šå¤§æ¨¡å‹è¯­éŸ³é—®ç­”ç³»ç»Ÿï¼</p>
                        <p>ğŸ† ç³»ç»ŸåŸºäºDeepSeek-R1è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæµ‹è¯•ç‰ˆæœ¬0.3V</p>
                        <p>è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ</p>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥æ§åˆ¶åŒºåŸŸ -->
            <div class="input-area">
                <!-- é—®é¢˜è¾“å…¥æ¡† -->
                <input type="text" id="question" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off">
                <!-- å¼ºåˆ¶ç»“æŸæŒ‰é’® -->
                <button id="stop-btn" title="å¼ºåˆ¶ç»“æŸå›ç­”"></button>
                <!-- å·¥å…·ç®±æŒ‰é’® -->
                <button id="toolbox-btn" title="å·¥å…·ç®±">ğŸ”§ å·¥å…·ç®±</button>
                <!-- è¯­éŸ³æ§åˆ¶æŒ‰é’® -->
                <button id="voice-btn" title="è¯­éŸ³å¼€å…³/è¯†åˆ«">ğŸ¤ è¯­éŸ³ å…³</button>
                <!-- å‘é€æŒ‰é’® -->
                <button id="send-btn" onclick="sendQuestion()">ğŸ“¤ å‘é€</button>
            </div>
        </div>
    </div>

    <!-- å·¥å…·ç®±å¼¹çª— -->
    <div id="toolbox-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content toolbox-modal">
            <div class="modal-header">
                <h3>ğŸ”§ å·¥å…·ç®±</h3>
                <button class="close-btn" onclick="closeToolbox()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="toolbox-options">
                    <!-- çŸ¥è¯†åº“å¢å¼ºå¼€å…³ -->
                    <div class="toolbox-item">
                        <button id="rag-toggle-btn" class="toolbox-action-btn">
                            <span class="toolbox-icon">ğŸ“š</span>
                            <span class="toolbox-text">å¯åŠ¨çŸ¥è¯†åº“å¢å¼º</span>
                            <span class="toolbox-status" id="rag-status">å…³</span>
                        </button>
                    </div>
                    
                    <!-- æ¸…ç©ºä¸Šä¸‹æ–‡ -->
                    <div class="toolbox-item">
                        <button id="clear-context-btn" class="toolbox-action-btn">
                            <span class="toolbox-icon">ğŸ—‘ï¸</span>
                            <span class="toolbox-text">æ¸…ç©ºä¸Šä¸‹æ–‡</span>
                        </button>
                    </div>

                    <!-- é‡æ–°åˆå§‹åŒ–çŸ¥è¯†åº“ -->
                    <div class="toolbox-item">
                        <button id="rag-reinit-btn" class="toolbox-action-btn">
                            <span class="toolbox-icon">ğŸ”„</span>
                            <span class="toolbox-text">é‡æ–°åˆå§‹åŒ–çŸ¥è¯†åº“</span>
                        </button>
                    </div>

                    <!-- ç¼–è¾‘çŸ¥è¯†åº“ï¼šè·³è½¬åˆ° ChatKG -->
                    <div class="toolbox-item">
                        <a class="toolbox-action-btn" href="/aiModels/tool/chatkg">
                            <span class="toolbox-icon">ğŸ“</span>
                            <span class="toolbox-text">ç¼–è¾‘çŸ¥è¯†åº“</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çŸ¥è¯†åº“åŠ è½½å¼¹çª— -->
    <div id="rag-loading-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“š çŸ¥è¯†åº“åŠ è½½ä¸­</h3>
            </div>
            <div class="modal-body">
                <div class="loading-spinner"></div>
                <p id="rag-loading-text">æ­£åœ¨åˆå§‹åŒ–çŸ¥è¯†åº“...</p>
            </div>
        </div>
    </div>

    <!-- åœæ­¢ç¡®è®¤å¼¹çª— -->
    <div id="stop-confirmation-modal" class="stop-confirmation-overlay" style="display: none;">
        <div class="stop-confirmation">
            <h3>â¹ æ“ä½œå·²åœæ­¢</h3>
            <p>æ˜¯å¦æ¢ä¸€ä¸ªé—®é¢˜ï¼Ÿ</p>
            <p class="voice-hint">ğŸ¤ ä¹Ÿå¯ä»¥ç›´æ¥è¯´"ç»§ç»­"æˆ–"å–æ¶ˆ"</p>
            <div class="confirmation-buttons">
                <button class="confirmation-btn confirm-yes" onclick="handleContinueCommand()">æ˜¯</button>
                <button class="confirmation-btn confirm-no" onclick="handleCancelCommand()">å¦</button>
            </div>
        </div>
    </div>

    <script>
        // ========== DOMå…ƒç´ è·å– ==========
        const chatBox = document.getElementById('chat-box');        // èŠå¤©æ¡†å…ƒç´ 
        const questionInput = document.getElementById('question');   // é—®é¢˜è¾“å…¥æ¡†
        const sendBtn = document.getElementById('send-btn');         // å‘é€æŒ‰é’®
        const voiceBtn = document.getElementById('voice-btn');       // è¯­éŸ³æŒ‰é’®
        const stopBtn = document.getElementById('stop-btn');         // å¼ºåˆ¶ç»“æŸæŒ‰é’®
        const toolboxBtn = document.getElementById('toolbox-btn');   // å·¥å…·ç®±æŒ‰é’®
        const toolboxModal = document.getElementById('toolbox-modal'); // å·¥å…·ç®±å¼¹çª—
        const ragToggleBtn = document.getElementById('rag-toggle-btn'); // çŸ¥è¯†åº“åˆ‡æ¢æŒ‰é’®
        const ragStatus = document.getElementById('rag-status');     // çŸ¥è¯†åº“çŠ¶æ€æ˜¾ç¤º
        const clearContextBtn = document.getElementById('clear-context-btn'); // æ¸…ç©ºä¸Šä¸‹æ–‡æŒ‰é’®
        const ragLoadingModal = document.getElementById('rag-loading-modal'); // çŸ¥è¯†åº“åŠ è½½å¼¹çª—
        const ragLoadingText = document.getElementById('rag-loading-text');   // åŠ è½½çŠ¶æ€æ–‡æœ¬
        const ragToggleText = ragToggleBtn.querySelector('.toolbox-text');    // æŒ‰é’®æ–‡å­—
        const ragReinitBtn = document.getElementById('rag-reinit-btn');       // é‡æ–°åˆå§‹åŒ–æŒ‰é’®
        const stopConfirmationModal = document.getElementById('stop-confirmation-modal'); // åœæ­¢ç¡®è®¤å¼¹çª—

        // ========== å…¨å±€çŠ¶æ€å˜é‡ ==========
        let isProcessing = false;            // æ˜¯å¦æ­£åœ¨å¤„ç†å›ç­”
        let currentAbortController = null;   // å½“å‰è¯·æ±‚çš„AbortController
        let systemOnline = true;             // ç³»ç»Ÿåœ¨çº¿çŠ¶æ€
        let ragEnabled = false;              // çŸ¥è¯†åº“å¢å¼ºæ˜¯å¦å¯ç”¨
        let ragInitialized = false;          // çŸ¥è¯†åº“æ˜¯å¦å·²åˆå§‹åŒ–
        let chatHistory = [];                // èŠå¤©å†å²è®°å½•
        
        // æ–°å¢ï¼šé™éŸ³è¶…æ—¶ä¸ç­‰å¾…è¯­éŸ³æ ‡è®°
        let silenceTimerId = null;           // è¯­éŸ³ç›‘å¬çš„é™éŸ³è¶…æ—¶å®šæ—¶å™¨
        let awaitingSpeech = false;          // æ˜¯å¦åœ¨ç­‰å¾…è¯­éŸ³è¾“å…¥
        
        // æ–°å¢ï¼šè¯­éŸ³æ§åˆ¶åŠŸèƒ½çŠ¶æ€å˜é‡
        let voiceControlEnabled = false;     // è¯­éŸ³æ§åˆ¶æ˜¯å¦å¯ç”¨
        let isListeningForCommand = false;   // æ˜¯å¦æ­£åœ¨ç›‘å¬è¯­éŸ³æŒ‡ä»¤
        let commandRecognition = null;       // è¯­éŸ³æŒ‡ä»¤è¯†åˆ«å®ä¾‹
        let currentThinkingId = null;         // å½“å‰æ€è€ƒä¸­æ¶ˆæ¯çš„ID
        let stopConfirmationShown = false;   // æ˜¯å¦å·²æ˜¾ç¤ºåœæ­¢ç¡®è®¤
        
        // æ–°å¢ï¼šç‹¬ç«‹çš„ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬å˜é‡
        let confirmationRecognition = null;  // ç¡®è®¤å¼¹çª—ä¸“ç”¨è¯­éŸ³è¯†åˆ«å®ä¾‹
        let isListeningForConfirmation = false; // æ˜¯å¦æ­£åœ¨ç›‘å¬ç¡®è®¤æŒ‡ä»¤

        // ========== å·¥å…·ç®±åŠŸèƒ½æ¨¡å— ==========
        /**
         * æ‰“å¼€å·¥å…·ç®±å¼¹çª—
         */
        function openToolbox() {
            toolboxModal.style.display = 'flex';
            updateToolboxStatus();
        }

        /**
         * å…³é—­å·¥å…·ç®±å¼¹çª—
         */
        function closeToolbox() {
            toolboxModal.style.display = 'none';
        }

        /**
         * æ›´æ–°å·¥å…·ç®±çŠ¶æ€æ˜¾ç¤º
         */
        function updateToolboxStatus() {
            if (ragInitialized && ragEnabled) {
                ragStatus.textContent = 'å¼€';
                ragStatus.className = 'toolbox-status enabled';
                ragToggleBtn.classList.add('enabled');
                if (ragToggleText) ragToggleText.textContent = 'å…³é—­çŸ¥è¯†åº“å¢å¼º';
            } else if (ragInitialized && !ragEnabled) {
                ragStatus.textContent = 'å…³';
                ragStatus.className = 'toolbox-status disabled';
                ragToggleBtn.classList.remove('enabled');
                if (ragToggleText) ragToggleText.textContent = 'å¯åŠ¨çŸ¥è¯†åº“å¢å¼º';
            } else {
                ragStatus.textContent = 'æœªåˆå§‹åŒ–';
                ragStatus.className = 'toolbox-status disabled';
                ragToggleBtn.classList.remove('enabled');
                if (ragToggleText) ragToggleText.textContent = 'å¯åŠ¨å¹¶åˆå§‹åŒ–çŸ¥è¯†åº“';
            }
        }

        /**
         * åˆ‡æ¢çŸ¥è¯†åº“å¢å¼ºçŠ¶æ€
         */
        function toggleRAG() {
            if (!ragInitialized) {
                // é¦–æ¬¡ç‚¹å‡»ï¼šåˆå§‹åŒ–çŸ¥è¯†åº“
                initializeRAG().catch(error => {
                    console.error('çŸ¥è¯†åº“åˆå§‹åŒ–å¤±è´¥:', error);
                    addMessage('bot', 'âŒ çŸ¥è¯†åº“åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                });
            } else {
                // å·²åˆå§‹åŒ–ï¼šåˆ‡æ¢å¯ç”¨çŠ¶æ€
                ragEnabled = !ragEnabled;
                updateToolboxStatus();
            }
        }

        /**
         * æ¸…ç©ºèŠå¤©ä¸Šä¸‹æ–‡
         */
        function clearChatContext() {
            // è°ƒç”¨åç«¯APIæ¸…ç©ºå†å²è®°å½•
            fetch('/aiModels/clear_chat_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…ç©ºèŠå¤©æ¡†å†…å®¹
                    chatBox.innerHTML = '';
                    
                    // æ¸…ç©ºå‰ç«¯æœ¬åœ°èŠå¤©å†å²è®°å½•
                    chatHistory = [];
                    
                    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                    addMessage('bot', 'ğŸŒ± æ¬¢è¿ä½¿ç”¨AIoTå®éªŒå®¤çš„å†œä¸šå¤§æ¨¡å‹è¯­éŸ³é—®ç­”ç³»ç»Ÿï¼\nğŸ† ç³»ç»ŸåŸºäºDeepSeek-R1è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæµ‹è¯•ç‰ˆæœ¬0.3V\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ', '', false, true);
                    
                    // å…³é—­å·¥å…·ç®±å¼¹çª—
                    closeToolbox();
                    
                    console.log('èŠå¤©ä¸Šä¸‹æ–‡å·²æ¸…ç©º');
                } else {
                    console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', data.error);
                    addMessage('bot', 'âŒ æ¸…ç©ºå†å²è®°å½•å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('æ¸…ç©ºå†å²è®°å½•è¯·æ±‚å¤±è´¥:', error);
                addMessage('bot', 'âŒ æ¸…ç©ºå†å²è®°å½•è¯·æ±‚å¤±è´¥: ' + error.message);
            });
        }

        // ========== å·¥å…·ç®±äº‹ä»¶ç›‘å¬ ==========
        // å·¥å…·ç®±æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        toolboxBtn.addEventListener('click', openToolbox);
        
        // çŸ¥è¯†åº“åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        ragToggleBtn.addEventListener('click', toggleRAG);
        
        // æ¸…ç©ºä¸Šä¸‹æ–‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        clearContextBtn.addEventListener('click', clearChatContext);
        
        // é‡æ–°åˆå§‹åŒ–çŸ¥è¯†åº“
        ragReinitBtn.addEventListener('click', reinitializeRAG);
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
        toolboxModal.addEventListener('click', function(e) {
            if (e.target === toolboxModal) {
                closeToolbox();
            }
        });

        // ========== ç³»ç»ŸçŠ¶æ€ç®¡ç† ==========
        /**
         * æ›´æ–°ç³»ç»ŸçŠ¶æ€
         * @param {boolean} online - ç³»ç»Ÿæ˜¯å¦åœ¨çº¿
         * @param {string} reason - ç¦»çº¿åŸå› ï¼ˆå¯é€‰ï¼‰
         */
        function updateSystemStatus(online, reason = '') {
            systemOnline = online;
            // ç®€å•è®°å½•çŠ¶æ€
            if (online) {
                console.log('ç³»ç»ŸçŠ¶æ€: åœ¨çº¿');
            } else {
                console.log('ç³»ç»ŸçŠ¶æ€: ç¦»çº¿ -', reason || 'æœªçŸ¥åŸå› ');
            }
        }

        // ========== é”®ç›˜äº‹ä»¶ç›‘å¬ ==========
        // ç›‘å¬å›è½¦é”®å‘é€æ¶ˆæ¯
        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();  // è°ƒç”¨å‘é€é—®é¢˜å‡½æ•°
            }
        });

        // ========== è¯­éŸ³åŠŸèƒ½æ¨¡å—ï¼ˆè¯­éŸ³è¯†åˆ« + è¯­éŸ³åˆæˆï¼‰ ==========
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const hasRecognition = !!SpeechRecognition;  // æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
        const hasTTS = 'speechSynthesis' in window;  // æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ

        // è¯­éŸ³åŠŸèƒ½çŠ¶æ€å˜é‡
        let speechEnabled = false;   // è¯­éŸ³åŠŸèƒ½æ€»å¼€å…³
        let recognizing = false;     // æ˜¯å¦æ­£åœ¨å¬å†™çŠ¶æ€
        let recognition = null;      // è¯­éŸ³è¯†åˆ«å®ä¾‹
        
        // æ–°å¢ï¼šå¯åŠ¨è¯†åˆ«å¹¶è®¾ç½®é™éŸ³è¶…æ—¶
        function startListeningWithSilenceTimeout(timeoutMs = 5000) {
            if (!speechEnabled) return;
            if (!hasRecognition) return;
            if (!recognition) return;
            try {
                // æ¸…ç†æ—§çš„å®šæ—¶å™¨
                if (silenceTimerId) {
                    clearTimeout(silenceTimerId);
                    silenceTimerId = null;
                }
                awaitingSpeech = true;
                recognition.start();
                // è®¾ç½®é™éŸ³è¶…æ—¶ï¼šè‹¥è¶…æ—¶ä»æœªæœ‰è¯†åˆ«ç»“æœï¼Œåˆ™åœæ­¢è¯†åˆ«
                silenceTimerId = setTimeout(() => {
                    if (awaitingSpeech && recognizing) {
                        try { recognition.stop(); } catch (e) { console.warn(e); }
                    }
                    awaitingSpeech = false;
                    silenceTimerId = null;
                }, timeoutMs);
            } catch (e) {
                console.warn(e);
            }
        }
        
        function clearSilenceTimer() {
            if (silenceTimerId) {
                clearTimeout(silenceTimerId);
                silenceTimerId = null;
            }
        }

        /**
         * æ£€æŸ¥è¯­éŸ³åŠŸèƒ½æ”¯æŒæƒ…å†µå¹¶æ›´æ–°ç³»ç»ŸçŠ¶æ€
         */
        function checkVoiceSupport() {
            if (!hasRecognition && !hasTTS) {
                updateSystemStatus(false, 'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½');
                return false;
            }
            return true;
        }

        /**
         * æ›´æ–°è¯­éŸ³æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
         * æ ¹æ®å½“å‰è¯­éŸ³åŠŸèƒ½çŠ¶æ€å’Œå¬å†™çŠ¶æ€æ›´æ–°æŒ‰é’®æ–‡å­—å’Œæ ·å¼
         */
        function updateVoiceBtn() {
            if (!speechEnabled) {
                // è¯­éŸ³åŠŸèƒ½å…³é—­çŠ¶æ€
                voiceBtn.textContent = 'ğŸ¤ è¯­éŸ³ å…³';
                voiceBtn.classList.remove('listening');
            } else if (recognizing) {
                // æ­£åœ¨å¬å†™çŠ¶æ€
                voiceBtn.textContent = 'ğŸ¤ åœæ­¢å¬';
                voiceBtn.classList.add('listening');
            } else {
                // è¯­éŸ³åŠŸèƒ½å¼€å¯ä½†æœªåœ¨å¬å†™çŠ¶æ€
                voiceBtn.textContent = 'ğŸ¤ å¼€å§‹å¬';
                voiceBtn.classList.remove('listening');
            }
            
            // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ï¼Œæ˜¾ç¤ºä¸å¯ç”¨çŠ¶æ€
            if (!hasRecognition && !hasTTS) {
                voiceBtn.textContent = 'ğŸ¤ è¯­éŸ³ä¸å¯ç”¨';
                voiceBtn.classList.add('disabled');
            }
        }

        /**
         * åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«åŠŸèƒ½
         * åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹å¹¶è®¾ç½®ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
         */
        function initRecognition() {
            if (!hasRecognition) return;  // ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åˆ™é€€å‡º
            if (recognition) return;      // å·²åˆå§‹åŒ–åˆ™é€€å‡º
            
            // åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';           // è®¾ç½®è¯†åˆ«è¯­è¨€ä¸ºä¸­æ–‡
            recognition.continuous = false;       // éè¿ç»­è¯†åˆ«
            recognition.interimResults = false;   // ä¸æ˜¾ç¤ºä¸­é—´ç»“æœ

            // è¯­éŸ³è¯†åˆ«å¼€å§‹äº‹ä»¶
            recognition.onstart = () => {
                recognizing = true;
                updateVoiceBtn();
            };
            
            // è¯­éŸ³è¯†åˆ«é”™è¯¯äº‹ä»¶
            recognition.onerror = (e) => {
                recognizing = false;
                awaitingSpeech = false;           // æ–°å¢ï¼šé”™è¯¯æ—¶ç»“æŸç­‰å¾…
                clearSilenceTimer();              // æ–°å¢ï¼šæ¸…ç†é™éŸ³è®¡æ—¶
                updateVoiceBtn();
                console.error('Speech recognition error:', e);
                // è¯­éŸ³è¯†åˆ«é”™è¯¯æ—¶æ›´æ–°ç³»ç»ŸçŠ¶æ€
                updateSystemStatus(false, 'è¯­éŸ³è¯†åˆ«æœåŠ¡å¼‚å¸¸');
            };
            
            // è¯­éŸ³è¯†åˆ«ç»“æŸäº‹ä»¶
            recognition.onend = () => {
                recognizing = false;
                awaitingSpeech = false;           // æ–°å¢ï¼šç»“æŸæ—¶ç»“æŸç­‰å¾…
                clearSilenceTimer();              // æ–°å¢ï¼šæ¸…ç†é™éŸ³è®¡æ—¶
                updateVoiceBtn();
            };
            
            // è¯­éŸ³è¯†åˆ«ç»“æœäº‹ä»¶
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;  // è·å–è¯†åˆ«ç»“æœ
                if (transcript) {
                    awaitingSpeech = false;       // æ–°å¢ï¼šæ”¶åˆ°ç»“æœ
                    clearSilenceTimer();          // æ–°å¢ï¼šæ¸…ç†é™éŸ³è®¡æ—¶
                    questionInput.value = transcript;  // å°†è¯†åˆ«ç»“æœå¡«å…¥è¾“å…¥æ¡†
                    sendQuestion();                    // è‡ªåŠ¨å‘é€é—®é¢˜
                }
            };
        }

        /**
         * åˆå§‹åŒ–ç¡®è®¤å¼¹çª—ä¸“ç”¨è¯­éŸ³è¯†åˆ«åŠŸèƒ½
         * ä¸“é—¨ç”¨äºç›‘å¬"æ˜¯"ã€"å¦"ç­‰ç¡®è®¤æŒ‡ä»¤
         */
        function initConfirmationRecognition() {
            if (!hasRecognition) return;
            if (confirmationRecognition) return;
            
            confirmationRecognition = new SpeechRecognition();
            confirmationRecognition.lang = 'zh-CN';
            confirmationRecognition.continuous = true;      // è¿ç»­è¯†åˆ«
            confirmationRecognition.interimResults = true;  // æ˜¾ç¤ºä¸­é—´ç»“æœï¼Œæé«˜å“åº”é€Ÿåº¦
            
            confirmationRecognition.onstart = () => {
                isListeningForConfirmation = true;
                console.log('ç¡®è®¤å¼¹çª—ï¼šå¼€å§‹ç›‘å¬è¯­éŸ³æŒ‡ä»¤');
            };
            
            confirmationRecognition.onerror = (e) => {
                isListeningForConfirmation = false;
                console.error('ç¡®è®¤å¼¹çª—è¯­éŸ³è¯†åˆ«é”™è¯¯:', e);
            };
            
            confirmationRecognition.onend = () => {
                isListeningForConfirmation = false;
                console.log('ç¡®è®¤å¼¹çª—ï¼šè¯­éŸ³æŒ‡ä»¤ç›‘å¬ç»“æŸ');
            };
            
            confirmationRecognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                // å¤„ç†è¯†åˆ«ç»“æœ
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // åˆå¹¶æœ€ç»ˆç»“æœå’Œä¸­é—´ç»“æœ
                const fullTranscript = (finalTranscript + interimTranscript).toLowerCase().trim();
                console.log('ç¡®è®¤å¼¹çª—è¯­éŸ³è¯†åˆ«ç»“æœ:', fullTranscript);
                
                // æ£€æŸ¥ç¡®è®¤æŒ‡ä»¤
                if (fullTranscript.includes('æ˜¯') || fullTranscript.includes('ç»§ç»­') || fullTranscript.includes('ä¸‹ä¸€ä¸ª')) {
                    console.log('ç¡®è®¤å¼¹çª—ï¼šæ”¶åˆ°"æ˜¯"æŒ‡ä»¤');
                    handleContinueCommand();
                } else if (fullTranscript.includes('å¦') || fullTranscript.includes('åœæ­¢') || fullTranscript.includes('å…³é—­') || fullTranscript.includes('å–æ¶ˆ')) {
                    console.log('ç¡®è®¤å¼¹çª—ï¼šæ”¶åˆ°"å¦"æŒ‡ä»¤');
                    handleCancelCommand();
                }
            };
        }

        /**
         * å¼€å§‹ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬
         */
        function startConfirmationListening() {
            if (!hasRecognition || !confirmationRecognition) {
                initConfirmationRecognition();
            }
            
            if (confirmationRecognition && !isListeningForConfirmation) {
                try {
                    confirmationRecognition.start();
                    console.log('ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬å·²å¯åŠ¨');
                } catch (e) {
                    console.warn('å¯åŠ¨ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬å¤±è´¥:', e);
                }
            }
        }

        /**
         * åœæ­¢ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬
         */
        function stopConfirmationListening() {
            if (confirmationRecognition && isListeningForConfirmation) {
                try {
                    confirmationRecognition.stop();
                    isListeningForConfirmation = false;
                    console.log('ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬å·²åœæ­¢');
                } catch (e) {
                    console.warn('åœæ­¢ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬å¤±è´¥:', e);
                }
            }
        }

        /**
         * åˆå§‹åŒ–è¯­éŸ³æŒ‡ä»¤è¯†åˆ«åŠŸèƒ½
         * ä¸“é—¨ç”¨äºç›‘å¬"åœæ­¢"ã€"æ˜¯"ã€"å¦"ã€"ç»§ç»­"ç­‰æŒ‡ä»¤
         */
        function initCommandRecognition() {
            if (!hasRecognition) return;
            if (commandRecognition) return;
            
            commandRecognition = new SpeechRecognition();
            commandRecognition.lang = 'zh-CN';
            commandRecognition.continuous = true;      // è¿ç»­è¯†åˆ«ï¼Œç”¨äºç›‘å¬æŒ‡ä»¤
            commandRecognition.interimResults = true;  // æ˜¾ç¤ºä¸­é—´ç»“æœï¼Œæé«˜å“åº”é€Ÿåº¦
            
            commandRecognition.onstart = () => {
                isListeningForCommand = true;
                console.log('å¼€å§‹ç›‘å¬è¯­éŸ³æŒ‡ä»¤');
            };
            
            commandRecognition.onerror = (e) => {
                isListeningForCommand = false;
                console.error('è¯­éŸ³æŒ‡ä»¤è¯†åˆ«é”™è¯¯:', e);
            };
            
            commandRecognition.onend = () => {
                isListeningForCommand = false;
                console.log('è¯­éŸ³æŒ‡ä»¤ç›‘å¬ç»“æŸ');
            };
            
            commandRecognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                // å¤„ç†è¯†åˆ«ç»“æœ
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // åˆå¹¶æœ€ç»ˆç»“æœå’Œä¸­é—´ç»“æœ
                const fullTranscript = (finalTranscript + interimTranscript).toLowerCase().trim();
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«æŒ‡ä»¤å…³é”®è¯
                console.log('è¯­éŸ³æŒ‡ä»¤è¯†åˆ«ç»“æœ:', fullTranscript);
                
                // åªå¤„ç†"åœæ­¢"æŒ‡ä»¤ï¼ˆç¡®è®¤å¼¹çª—çš„"æ˜¯"/"å¦"ç”±ç‹¬ç«‹çš„ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬å¤„ç†ï¼‰
                if (fullTranscript.includes('ç»“æŸé—®ç­”') || fullTranscript.includes('ä¸‹ä¸ªé—®é¢˜') || fullTranscript.includes('åœæ­¢å›ç­”')) {
                    console.log('æ”¶åˆ°"åœæ­¢"æŒ‡ä»¤');
                    handleStopCommand();
                }
            };
        }

        /**
         * å¼€å§‹ç›‘å¬è¯­éŸ³æŒ‡ä»¤
         */
        function startCommandListening() {
            if (!hasRecognition || !commandRecognition) {
                initCommandRecognition();
            }
            
            if (commandRecognition && !isListeningForCommand) {
                try {
                    commandRecognition.start();
                    voiceControlEnabled = true;
                    console.log('è¯­éŸ³æ§åˆ¶å·²å¯ç”¨');
                } catch (e) {
                    console.warn('å¯åŠ¨è¯­éŸ³æŒ‡ä»¤ç›‘å¬å¤±è´¥:', e);
                }
            }
        }

        /**
         * åœæ­¢ç›‘å¬è¯­éŸ³æŒ‡ä»¤
         */
        function stopCommandListening() {
            if (commandRecognition && isListeningForCommand) {
                try {
                    commandRecognition.stop();
                    voiceControlEnabled = false;
                    isListeningForCommand = false;
                    console.log('è¯­éŸ³æ§åˆ¶å·²åœç”¨');
                } catch (e) {
                    console.warn('åœæ­¢è¯­éŸ³æŒ‡ä»¤ç›‘å¬å¤±è´¥:', e);
                }
            }
        }

        /**
         * å¤„ç†"åœæ­¢"æŒ‡ä»¤
         */
        function handleStopCommand() {
            console.log('æ”¶åˆ°åœæ­¢æŒ‡ä»¤');
            
            // åœæ­¢è¯­éŸ³æ’­æŠ¥
            if (hasTTS) {
                window.speechSynthesis.cancel();
            }
            
            // åœæ­¢è¯­éŸ³è¯†åˆ«
            if (hasRecognition && recognition && recognizing) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.warn('åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥:', e);
                }
            }
            
            // å–æ¶ˆç½‘ç»œè¯·æ±‚
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }
            
            // ç§»é™¤æ€è€ƒä¸­æ¶ˆæ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentThinkingId) {
                const thinkingElement = document.getElementById(currentThinkingId);
                if (thinkingElement) {
                    thinkingElement.textContent = 'â¹ æ€è€ƒå·²åœæ­¢';
                }
                currentThinkingId = null;
            }
            
            // åœæ­¢åŸæœ‰çš„è¯­éŸ³æŒ‡ä»¤ç›‘å¬
            stopCommandListening();
            
            // æ˜¾ç¤ºåœæ­¢ç¡®è®¤ï¼ˆä¼šè‡ªåŠ¨å¯åŠ¨ç‹¬ç«‹çš„ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬ï¼‰
            showStopConfirmation();
        }

        /**
         * å¤„ç†"æ˜¯"æˆ–"ç»§ç»­"æŒ‡ä»¤
         */
        function handleContinueCommand() {
            console.log('æ”¶åˆ°ç»§ç»­æŒ‡ä»¤');
            hideStopConfirmation();
            
            // é‡æ–°å¯ç”¨è¯­éŸ³åŠŸèƒ½
            speechEnabled = true;
            if (hasRecognition) {
                initRecognition();
            }
            
            // å¼€å§‹æ–°çš„è¯­éŸ³ç›‘å¬
            if (hasRecognition && recognition) {
                startListeningWithSilenceTimeout(10000);
            }
            
            updateVoiceBtn();
        }

        /**
         * å¤„ç†"å¦"æŒ‡ä»¤
         */
        function handleCancelCommand() {
            console.log('æ”¶åˆ°å–æ¶ˆæŒ‡ä»¤');
            hideStopConfirmation();
            
            // å…³é—­è¯­éŸ³åŠŸèƒ½
            speechEnabled = false;
            recognizing = false;
            awaitingSpeech = false;
            clearSilenceTimer();
            
            updateVoiceBtn();
        }

        /**
         * æ˜¾ç¤ºåœæ­¢ç¡®è®¤å¼¹çª—
         */
        function showStopConfirmation() {
            if (stopConfirmationShown) return;
            
            stopConfirmationShown = true;
            stopConfirmationModal.style.display = 'flex';
            
            // é‡æ–°å¯ç”¨è¾“å…¥æ§ä»¶
            questionInput.disabled = false;
            sendBtn.disabled = false;
            questionInput.focus();
            
            // é‡ç½®å¤„ç†çŠ¶æ€
            isProcessing = false;
            currentAbortController = null;
            
            // éšè—å¼ºåˆ¶ç»“æŸæŒ‰é’®
            stopBtn.style.display = 'none';
            
            // å¯åŠ¨ç‹¬ç«‹çš„ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬
            if (hasRecognition) {
                startConfirmationListening();
                
                // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (hasTTS) {
                    setTimeout(() => {
                        const hintUtter = new SpeechSynthesisUtterance('è¯·è¯´"ç»§ç»­"æˆ–"å–æ¶ˆ"');
                        hintUtter.lang = 'zh-CN';
                        hintUtter.rate = 0.8;
                        hintUtter.volume = 0.5;
                        window.speechSynthesis.speak(hintUtter);
                    }, 500);
                }
            }
            
            console.log('æ˜¾ç¤ºåœæ­¢ç¡®è®¤å¼¹çª—');
        }

        /**
         * éšè—åœæ­¢ç¡®è®¤å¼¹çª—
         */
        function hideStopConfirmation() {
            if (!stopConfirmationShown) return;
            
            stopConfirmationShown = false;
            stopConfirmationModal.style.display = 'none';
            
            // åœæ­¢ç‹¬ç«‹çš„ç¡®è®¤å¼¹çª—è¯­éŸ³ç›‘å¬
            stopConfirmationListening();
            
            console.log('éšè—åœæ­¢ç¡®è®¤å¼¹çª—');
        }

        /**
         * åˆ‡æ¢è¯­éŸ³åŠŸèƒ½çŠ¶æ€
         * é¦–æ¬¡ç‚¹å‡»å¼€å¯è¯­éŸ³åŠŸèƒ½ï¼Œåç»­ç‚¹å‡»æ§åˆ¶å¬å†™å¼€å§‹/åœæ­¢
         */
        function toggleVoice() {
            if (!speechEnabled) {
                // é¦–æ¬¡ç‚¹å‡»ï¼šå¼€å¯è¯­éŸ³åŠŸèƒ½
                speechEnabled = true;
                if (hasRecognition) initRecognition();  // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
                updateVoiceBtn();
                return;
            }
            
            // å·²å¼€å¯è¯­éŸ³åŠŸèƒ½ï¼šç‚¹å‡»ä½œä¸ºå¼€å§‹/åœæ­¢å¬å†™çš„è§¦å‘
            if (hasRecognition && recognition) {
                if (!recognizing) {
                    // å¼€å§‹å¬å†™
                    try { 
                        recognition.start(); 
                    } catch (e) { 
                        console.warn(e); 
                        updateSystemStatus(false, 'è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥');
                    }
                } else {
                    // åœæ­¢å¬å†™
                    try { 
                        recognition.stop(); 
                    } catch (e) { 
                        console.warn(e); 
                    }
                }
            }
            updateVoiceBtn();
        }

        // è¯­éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶ç›‘å¬
        voiceBtn.addEventListener('click', () => {
            if (!hasRecognition && !hasTTS) return; // æ— è¯­éŸ³èƒ½åŠ›åˆ™å¿½ç•¥ç‚¹å‡»
            toggleVoice();
        });

        /**
         * è¯­éŸ³åˆæˆæœ—è¯»åŠŸèƒ½
         * @param {string} text - è¦æœ—è¯»çš„æ–‡æœ¬å†…å®¹
         */
        function speak(text) {
            if (!speechEnabled) return;  // è¯­éŸ³åŠŸèƒ½æœªå¼€å¯åˆ™é€€å‡º
            if (!hasTTS) return;         // ä¸æ”¯æŒè¯­éŸ³åˆæˆåˆ™é€€å‡º
            if (!text || !text.trim()) return;  // æ–‡æœ¬ä¸ºç©ºåˆ™é€€å‡º
            console.log("è¯­éŸ³æ’­æŠ¥å†…å®¹ï¼š", text)

            try {
                // åœæ­¢å½“å‰æœªå®Œæˆçš„æœ—è¯»
                window.speechSynthesis.cancel();
                
                // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
                stopBtn.style.display = 'inline-block';
                console.log('æ˜¾ç¤ºåœæ­¢æŒ‰é’® - å¼€å§‹è¯­éŸ³æ’­æ”¾');
                
                // åˆ›å»ºè¯­éŸ³åˆæˆå®ä¾‹
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'zh-CN';     // è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡
                utter.rate = 1.0;         // è®¾ç½®è¯­é€Ÿ
                utter.pitch = 1.0;        // è®¾ç½®éŸ³è°ƒ
                
                // æ·»åŠ è¯­éŸ³äº‹ä»¶ç›‘å¬å™¨
                utter.onstart = function() {
                    console.log('è¯­éŸ³æ’­æ”¾å¼€å§‹');
                    // ç¡®ä¿åœ¨è¯­éŸ³å¼€å§‹æ—¶æŒ‰é’®æ˜¯æ˜¾ç¤ºçš„
                    stopBtn.style.display = 'inline-block';
                    
                    // å¼€å§‹ç›‘å¬è¯­éŸ³æŒ‡ä»¤ï¼ˆå¦‚æœè¯­éŸ³åŠŸèƒ½å·²å¯ç”¨ï¼‰
                    if (speechEnabled && hasRecognition) {
                        initCommandRecognition();
                        setTimeout(() => {
                            startCommandListening();
                        }, 200);
                    }
                };
                
                utter.onend = function() {
                    console.log('è¯­éŸ³æ’­æ”¾ç»“æŸ');
                    // è¯­éŸ³æ’­æ”¾ç»“æŸæ—¶éšè—åœæ­¢æŒ‰é’®
                    stopBtn.style.display = 'none';
                    console.log('éšè—åœæ­¢æŒ‰é’® - è¯­éŸ³æ’­æ”¾ç»“æŸ');
                    
                    // åœæ­¢è¯­éŸ³æŒ‡ä»¤ç›‘å¬
                    stopCommandListening();
                    
                    // æ–°å¢ï¼šæ’­æŠ¥å®Œæˆåè‡ªåŠ¨å¼€å§‹éº¦å…‹é£ç›‘å¬ï¼Œ10ç§’æ— è¾“å…¥è‡ªåŠ¨å…³é—­
                    if (speechEnabled && hasRecognition && recognition) {
                        startListeningWithSilenceTimeout(10000);
                    }
                };
                
                utter.onerror = function(event) {
                    console.warn('è¯­éŸ³æ’­æ”¾é”™è¯¯:', event.error);
                    updateSystemStatus(false, 'è¯­éŸ³æ’­æ”¾æœåŠ¡å¼‚å¸¸');
                    // è¯­éŸ³æ’­æ”¾é”™è¯¯æ—¶éšè—åœæ­¢æŒ‰é’®
                    stopBtn.style.display = 'none';
                    console.log('éšè—åœæ­¢æŒ‰é’® - è¯­éŸ³æ’­æ”¾é”™è¯¯');
                    
                    // åœæ­¢è¯­éŸ³æŒ‡ä»¤ç›‘å¬
                    stopCommandListening();
                };
                
                utter.onpause = function() {
                    console.log('è¯­éŸ³æ’­æ”¾æš‚åœ');
                };
                
                utter.onresume = function() {
                    console.log('è¯­éŸ³æ’­æ”¾æ¢å¤');
                };
                
                // å¼€å§‹æœ—è¯»
                window.speechSynthesis.speak(utter);
                console.log('å¼€å§‹è¯­éŸ³æ’­æ”¾:', text.substring(0, 50) + '...');
            } catch (e) {
                console.warn('TTS error:', e);
                updateSystemStatus(false, 'è¯­éŸ³åˆæˆæœåŠ¡å¼‚å¸¸');
                // è¯­éŸ³åˆæˆå¼‚å¸¸æ—¶éšè—åœæ­¢æŒ‰é’®
                stopBtn.style.display = 'none';
                console.log('éšè—åœæ­¢æŒ‰é’® - è¯­éŸ³åˆæˆå¼‚å¸¸');
            }
        }

        /**
         * å¼ºåˆ¶åœæ­¢æ‰€æœ‰å›ç­”åŠŸèƒ½
         * åœæ­¢è¯­éŸ³æœ—è¯»ã€ç½‘ç»œè¯·æ±‚å’Œé‡ç½®UIçŠ¶æ€
         */
        function forceStopAnswer() {
            // ç«‹å³åœæ­¢è¯­éŸ³æœ—è¯»
            if (hasTTS) {
                window.speechSynthesis.cancel();
                console.log('è¯­éŸ³æ’­æ”¾å·²åœæ­¢');
            }
            
            // åœæ­¢è¯­éŸ³è¯†åˆ«
            if (hasRecognition && recognition && recognizing) {
                try {
                    recognition.stop();
                    console.log('è¯­éŸ³è¯†åˆ«å·²åœæ­¢');
                } catch (e) {
                    console.warn('Stop recognition error:', e);
                }
            }
            
            // å–æ¶ˆç½‘ç»œè¯·æ±‚
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
                console.log('ç½‘ç»œè¯·æ±‚å·²å–æ¶ˆ');
            }
            
            // æ–°å¢ï¼šåœæ­¢è¯­éŸ³è¯†åˆ«ä¸é™éŸ³è®¡æ—¶
            awaitingSpeech = false;
            clearSilenceTimer();
            
            // åœæ­¢è¯­éŸ³æŒ‡ä»¤ç›‘å¬
            stopCommandListening();
            
            // é‡ç½®å¤„ç†çŠ¶æ€
            isProcessing = false;
            
            // éšè—åœæ­¢æŒ‰é’®
            stopBtn.style.display = 'none';
            console.log('éšè—åœæ­¢æŒ‰é’® - å¼ºåˆ¶åœæ­¢');
            
            // é‡æ–°å¯ç”¨è¾“å…¥æ§ä»¶
            questionInput.disabled = false;
            sendBtn.disabled = false;
            questionInput.focus();
            
            // æ›´æ–°è¯­éŸ³æŒ‰é’®çŠ¶æ€
            updateVoiceBtn();
            
            console.log('å¼ºåˆ¶åœæ­¢å›ç­”å®Œæˆ');
        }

        // å¼ºåˆ¶ç»“æŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶ç›‘å¬
        stopBtn.addEventListener('click', forceStopAnswer);

        // ========== çŸ¥è¯†åº“å¢å¼ºåŠŸèƒ½æ¨¡å—ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰ ==========
        /**
         * åˆå§‹åŒ–çŸ¥è¯†åº“å¢å¼ºåŠŸèƒ½
         * å‘é€è¯·æ±‚åˆ°åç«¯åˆå§‹åŒ–RAGç³»ç»Ÿ
         */
        function initializeRAG() {
            if (ragInitialized) return Promise.resolve();
            
            return new Promise((resolve, reject) => {
                // æ˜¾ç¤ºåŠ è½½å¼¹çª—
                ragLoadingModal.style.display = 'flex';
                ragLoadingText.textContent = 'æ­£åœ¨åˆå§‹åŒ–çŸ¥è¯†åº“...';
                ragToggleBtn.classList.add('loading');
                ragToggleBtn.disabled = true;
                
                // å‘é€åˆå§‹åŒ–è¯·æ±‚
                fetch('initialize_rag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        ragInitialized = true;
                        ragEnabled = true;
                        updateToolboxStatus();
                        ragLoadingText.textContent = 'çŸ¥è¯†åº“åŠ è½½å®Œæˆï¼';
                        ragToggleBtn.classList.remove('loading');
                        ragToggleBtn.disabled = false;
                        
                        // å»¶è¿Ÿå…³é—­å¼¹çª—
                        setTimeout(() => {
                            ragLoadingModal.style.display = 'none';
                            resolve();
                        }, 1000);
                    } else {
                        throw new Error(data.error || 'çŸ¥è¯†åº“åˆå§‹åŒ–å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('RAGåˆå§‹åŒ–é”™è¯¯:', error);
                    ragLoadingText.textContent = 'çŸ¥è¯†åº“åŠ è½½å¤±è´¥: ' + error.message;
                    ragToggleBtn.classList.remove('loading');
                    ragToggleBtn.disabled = false;
                    
                    // å»¶è¿Ÿå…³é—­å¼¹çª—
                    setTimeout(() => {
                        ragLoadingModal.style.display = 'none';
                        reject(error);
                    }, 2000);
                });
            });
        }

        /**
         * å‘é€é—®é¢˜åˆ°åç«¯å¹¶å¤„ç†å›å¤
         * è¿™æ˜¯æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼Œè´Ÿè´£ç”¨æˆ·äº¤äº’å’ŒAIå¯¹è¯
         */
        function sendQuestion() {
            const question = questionInput.value.trim();  // è·å–å¹¶æ¸…ç†ç”¨æˆ·è¾“å…¥
            if (!question) return;  // é—®é¢˜ä¸ºç©ºåˆ™é€€å‡º

            // è®¾ç½®å¤„ç†çŠ¶æ€
            isProcessing = true;

            // ç¦ç”¨è¾“å…¥æ§ä»¶é˜²æ­¢é‡å¤æäº¤
            questionInput.disabled = true;
            sendBtn.disabled = true;
            
            // æ˜¾ç¤ºå¼ºåˆ¶ç»“æŸæŒ‰é’®
            stopBtn.style.display = 'inline-block';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©æ¡†
            addMessage('user', question);
            questionInput.value = '';  // æ¸…ç©ºè¾“å…¥æ¡†

            // æ·»åŠ "æ€è€ƒä¸­..."æç¤ºæ¶ˆæ¯
            const thinkingId = 'thinking-' + Date.now();  // ç”Ÿæˆå”¯ä¸€ID
            currentThinkingId = thinkingId;  // ä¿å­˜å½“å‰æ€è€ƒä¸­æ¶ˆæ¯ID
            addMessage('bot', 'ğŸ¤” æ€è€ƒä¸­<span class="loading-dots"></span>', thinkingId, true);

            // æ»šåŠ¨åˆ°èŠå¤©æ¡†åº•éƒ¨
            chatBox.scrollTop = chatBox.scrollHeight;

            // å¼€å§‹ç›‘å¬è¯­éŸ³æŒ‡ä»¤ï¼ˆå¦‚æœè¯­éŸ³åŠŸèƒ½å·²å¯ç”¨ï¼‰
            if (speechEnabled && hasRecognition) {
                startCommandListening();
            }

            // åˆ›å»ºAbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
            currentAbortController = new AbortController();

            // æ ¹æ®æ˜¯å¦å¯ç”¨RAGé€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
            const apiEndpoint = ragEnabled ? 'get_answer_rag' : 'get_answer_deepseek';
            
            // å‘é€AJAXè¯·æ±‚åˆ°åç«¯API
            fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''  // Django CSRFä¿æŠ¤
                },
                body: JSON.stringify({ question: question }),  // å‘é€é—®é¢˜æ•°æ®
                signal: currentAbortController.signal  // æ·»åŠ å–æ¶ˆä¿¡å·
            })
            .then(response => {
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();  // è§£æJSONå“åº”
            })
            .then(data => {
                // ç§»é™¤"æ€è€ƒä¸­..."æ¶ˆæ¯
                const thinkingElement = document.getElementById(thinkingId);
                if (thinkingElement) {
                    thinkingElement.remove();
                }

                // åœæ­¢è¯­éŸ³æŒ‡ä»¤ç›‘å¬ï¼ˆæ€è€ƒç»“æŸï¼‰
                stopCommandListening();
                currentThinkingId = null;

                // å¤„ç†AIå›å¤
                if (data.answer) {
                    // æ·»åŠ AIå›å¤æ¶ˆæ¯
                    const msgEl = addMessage('bot', formatResponse(data.answer));
                    
                    // è¯­éŸ³æœ—è¯»å›å¤å†…å®¹ï¼ˆå¦‚æœè¯­éŸ³åŠŸèƒ½å¼€å¯ï¼‰
                    if (speechEnabled && hasTTS) {
                        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†å¼€å§‹è¯­éŸ³æ’­æ”¾ï¼Œç¡®ä¿æ¶ˆæ¯å·²ç»æ˜¾ç¤º
                        setTimeout(() => {
                            // ä½¿ç”¨çº¯æ–‡æœ¬ï¼ˆç§»é™¤HTML/Markdown/ä»£ç å—ç­‰ï¼‰
                            const speechText = toSpeechText(data.answer);
                            console.log("è¯­éŸ³æ’­æŠ¥å†…å®¹ï¼š", speechText);
                            speak(speechText);
                        }, 100);
                    }
                    // è¯·æ±‚æˆåŠŸï¼Œç¡®ä¿ç³»ç»ŸçŠ¶æ€ä¸ºåœ¨çº¿
                    updateSystemStatus(true);
                } else if (data.error) {
                    // å¤„ç†é”™è¯¯æƒ…å†µ
                    addMessage('bot', 'âŒ å‡ºé”™: ' + data.error);
                    updateSystemStatus(false, 'AIæœåŠ¡å“åº”å¼‚å¸¸');
                }

                // æ»šåŠ¨åˆ°èŠå¤©æ¡†åº•éƒ¨
                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(error => {
                // å¤„ç†è¯·æ±‚é”™è¯¯
                if (error.name === 'AbortError') {
                    console.log('è¯·æ±‚å·²è¢«ç”¨æˆ·å–æ¶ˆ');
                    // ç§»é™¤"æ€è€ƒä¸­..."æ¶ˆæ¯
                    const thinkingElement = document.getElementById(thinkingId);
                    if (thinkingElement) {
                        thinkingElement.textContent = 'â¹ å›ç­”å·²åœæ­¢';
                    }
                } else {
                    console.error('Error:', error);
                    const thinkingElement = document.getElementById(thinkingId);
                    if (thinkingElement) {
                        thinkingElement.textContent = 'âŒ è¯·æ±‚å‡ºé”™: ' + error.message;
                    }
                    // ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶æ›´æ–°ç³»ç»ŸçŠ¶æ€
                    updateSystemStatus(false, 'ç½‘ç»œè¿æ¥å¼‚å¸¸æˆ–æœåŠ¡ä¸å¯ç”¨');
                }
            })
            .finally(() => {
                // é‡ç½®å¤„ç†çŠ¶æ€
                isProcessing = false;
                currentAbortController = null;
                currentThinkingId = null;
                
                // åœæ­¢è¯­éŸ³æŒ‡ä»¤ç›‘å¬
                stopCommandListening();
                
                // éšè—å¼ºåˆ¶ç»“æŸæŒ‰é’®
                stopBtn.style.display = 'none';
                
                // æ— è®ºæˆåŠŸå¤±è´¥éƒ½é‡æ–°å¯ç”¨è¾“å…¥æ§ä»¶
                questionInput.disabled = false;
                sendBtn.disabled = false;
                questionInput.focus();  // é‡æ–°èšç„¦åˆ°è¾“å…¥æ¡†
                
                // æ›´æ–°è¯­éŸ³æŒ‰é’®çŠ¶æ€
                updateVoiceBtn();
            });
        }

        /**
         * æå–æ˜¾ç¤ºç»™ç”¨æˆ·çš„çº¯æ–‡æœ¬å†…å®¹
         * ç§»é™¤æ€ç»´é“¾å†…å®¹ï¼Œåªä¿ç•™æœ€ç»ˆå›å¤
         * @param {string} text - åŸå§‹AIå›å¤å†…å®¹
         * @returns {string} çº¯æ–‡æœ¬æ˜¾ç¤ºå†…å®¹
         */
        function extractDisplayText(text) {
            // å¤„ç†å¯èƒ½çš„æ€ç»´é“¾å†…å®¹
            const parts = text.split('*******************ä»¥ä¸Šä¸ºæ€ç»´é“¾å†…å®¹ï¼Œæ¨¡å‹å›å¤å†…å®¹å¦‚ä¸‹********************');
            
            if (parts.length > 1) {
                // å¦‚æœæœ‰æ€ç»´é“¾ï¼Œåªè¿”å›æœ€ç»ˆå›å¤éƒ¨åˆ†
                return parts[1].trim();
            } else {
                // å¦‚æœæ²¡æœ‰æ€ç»´é“¾ï¼Œè¿”å›åŸå§‹å†…å®¹
                return text;
            }
        }

        /**
         * å°† AI åŸå§‹å›å¤è½¬æ¢ä¸ºé€‚åˆ TTS çš„çº¯æ–‡æœ¬
         * 1) åˆ‡æ‰â€œæ€ç»´é“¾â€åˆ†éš”ç¬¦ä¹‹å‰çš„å†…å®¹
         * 2) å»æ‰ Markdown / ä»£ç å— / åˆ—è¡¨ / æ ‡é¢˜ ç­‰æ ‡è®°
         * 3) å»æ‰æ‰€æœ‰ HTML æ ‡ç­¾å¹¶è§£ç å®ä½“
         * 4) è§„æ•´ç©ºç™½å¹¶é™åˆ¶é•¿åº¦
         * @param {string} raw
         * @returns {string}
         */
        function toSpeechText(raw) {
            const text = extractDisplayText(raw);

            // ç§»é™¤å¤šè¡Œä»£ç å—
            let t = text.replace(/```[\s\S]*?```/g, '[ä»£ç ç‰‡æ®µç•¥]');

            // å›¾ç‰‡ä¸é“¾æ¥ï¼šä»…ä¿ç•™å¯è¯»æ–‡å­—
            t = t.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '$1');
            t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '$1');

            // è¡Œå†…ä»£ç 
            t = t.replace(/`([^`]+)`/g, '$1');

            // åŠ ç²—/æ–œä½“
            t = t.replace(/(\*\*|__)(.*?)\1/g, '$2')
                 .replace(/(\*|_)(.*?)\1/g, '$2');

            // æ ‡é¢˜ / å¼•ç”¨ / åˆ—è¡¨ç¬¦å·
            t = t.replace(/^\s{0,3}#{1,6}\s*/gm, '')
                 .replace(/^\s{0,3}>\s?/gm, '')
                 .replace(/^\s*([-*+]\s+|\d+\.\s+)/gm, 'â€¢ ');

            // å°† <br> å…ˆæ›¿æ¢æˆæ¢è¡Œï¼ˆä»¥ä¾¿ strip æ—¶ä¸ä¸¢è¯­ä¹‰ï¼‰
            t = t.replace(/<br\s*\/?>/gi, '\n');

            // æœ€åç§»é™¤æ‰€æœ‰ HTML æ ‡ç­¾å¹¶è§£ç å®ä½“
            t = stripHTMLTags(t);

            // è§„æ•´ç©ºç™½
            t = t.replace(/\u00A0/g, ' ')
                 .replace(/[ \t]+/g, ' ')
                 .replace(/\n{3,}/g, '\n\n')
                 .trim();

            const MAX_CHARS = 4000;
            return t.length > MAX_CHARS ? t.slice(0, MAX_CHARS) + ' â€¦' : t;
        }

        /** ç§»é™¤ HTML æ ‡ç­¾å¹¶è§£ç  HTML å®ä½“ */
        function stripHTMLTags(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        /**
         * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
         * @param {string} sender - å‘é€è€…ç±»å‹ ('user' æˆ– 'bot')
         * @param {string} content - æ¶ˆæ¯å†…å®¹
         * @param {string} id - æ¶ˆæ¯å…ƒç´ IDï¼ˆå¯é€‰ï¼‰
         * @param {boolean} isThinking - æ˜¯å¦ä¸ºæ€è€ƒä¸­çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
         * @returns {HTMLElement} åˆ›å»ºçš„æ¶ˆæ¯å…ƒç´ 
         */
        function addMessage(sender, content, id = '', isThinking = false) {
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            if (id) messageDiv.id = id;

            if (isThinking) {
                // æ€è€ƒä¸­çŠ¶æ€ï¼šç®€å•æ–‡æœ¬æ˜¾ç¤º
                messageDiv.classList.add('thinking');
                messageDiv.innerHTML = content;
            } else {
                // å¤„ç†å¯èƒ½çš„æ€ç»´é“¾å†…å®¹ï¼ˆAIæ¨ç†è¿‡ç¨‹ï¼‰
                const parts = content.split('*******************ä»¥ä¸Šä¸ºæ€ç»´é“¾å†…å®¹ï¼Œæ¨¡å‹å›å¤å†…å®¹å¦‚ä¸‹********************');

                if (parts.length > 1) {
                    // åŒ…å«æ€ç»´é“¾çš„å›å¤ï¼šåˆ†åˆ«å¤„ç†æ€ç»´é“¾å’Œæœ€ç»ˆå›å¤
                    const reasoningDiv = document.createElement('div');
                    reasoningDiv.className = 'reasoning';
                    reasoningDiv.innerHTML = formatResponse(parts[0].trim());
                    messageDiv.appendChild(reasoningDiv);

                    // æ·»åŠ åˆ†éš”çº¿
                    const separator = document.createElement('div');
                    separator.className = 'separator';
                    separator.textContent = 'ğŸ’­ æ¨¡å‹å›å¤å†…å®¹';
                    messageDiv.appendChild(separator);

                    // æ·»åŠ æœ€ç»ˆå›ç­”éƒ¨åˆ†
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'bot-content';
                    answerDiv.innerHTML = formatResponse(parts[1].trim());
                    messageDiv.appendChild(answerDiv);
                } else {
                    // æ™®é€šå›å¤ï¼šç›´æ¥æ ¼å¼åŒ–æ˜¾ç¤º
                    const contentDiv = document.createElement('div');
                    contentDiv.className = sender === 'bot' ? 'bot-content' : '';
                    contentDiv.innerHTML = sender === 'bot' ? formatResponse(content) : content;
                    messageDiv.appendChild(contentDiv);
                }
            }

            // å°†æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©æ¡†
            chatBox.appendChild(messageDiv);
            return messageDiv;
        }

        /**
         * æ ¼å¼åŒ–AIå›å¤å†…å®¹
         * å°†Markdownæ ¼å¼çš„æ–‡æœ¬è½¬æ¢ä¸ºHTMLæ ¼å¼
         * @param {string} text - åŸå§‹æ–‡æœ¬å†…å®¹
         * @returns {string} æ ¼å¼åŒ–åçš„HTMLå†…å®¹
         */
        function formatResponse(text) {
            // ä¿ç•™åŸå§‹æ¢è¡Œå’Œç©ºæ ¼
            let formatted = text.replace(/\n/g, '<br>');

            // æ ¼å¼åŒ–ä»£ç å— (```language\ncode\n```)
            formatted = formatted.replace(/```(\w*)\n([\s\S]*?)\n```/g,
                '<pre><code class="$1">$2</code></pre>');

            // æ ¼å¼åŒ–è¡Œå†…ä»£ç  (`code`)
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // æ ¼å¼åŒ–æ— åºåˆ—è¡¨ (* æˆ– - å¼€å¤´)
            formatted = formatted.replace(/^\s*\*\s(.*)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/^\s*-\s(.*)$/gm, '<li>$1</li>');
            
            // æ ¼å¼åŒ–æœ‰åºåˆ—è¡¨ (æ•°å­—. å¼€å¤´)
            formatted = formatted.replace(/^\s*\d+\.\s(.*)$/gm, '<li>$1</li>');

            // å°†è¿ç»­åˆ—è¡¨é¡¹åŒ…è£¹åœ¨ul/olæ ‡ç­¾ä¸­
            formatted = formatted.replace(/(<li>.*<\/li>)+/g, function(match) {
                return '<ul>' + match + '</ul>';
            });

            // æ ¼å¼åŒ–å¼•ç”¨å— (> å¼€å¤´)
            formatted = formatted.replace(/^>\s(.*)$/gm, '<blockquote>$1</blockquote>');

            // æ ¼å¼åŒ–æ ‡é¢˜ (# ## ### å¼€å¤´)
            formatted = formatted.replace(/^#\s(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/^##\s(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^###\s(.*)$/gm, '<h3>$1</h3>');

            // æ·»åŠ æ®µè½æ ‡ç­¾
            formatted = formatted.replace(/<br><br>/g, '</p><p>');
            formatted = '<p>' + formatted + '</p>';

            return formatted;
        }

        /**
         * è·å–Cookieå€¼çš„è¾…åŠ©å‡½æ•°
         * @param {string} name - Cookieåç§°
         * @returns {string|null} Cookieå€¼æˆ–null
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // æ–°å¢ï¼šé‡æ–°åˆå§‹åŒ–çŸ¥è¯†åº“å‡½æ•°
        function reinitializeRAG() {
            // æ˜¾ç¤ºåŠ è½½å¼¹çª—
            ragLoadingModal.style.display = 'flex';
            ragLoadingText.textContent = 'æ­£åœ¨é‡æ–°åˆå§‹åŒ–çŸ¥è¯†åº“...';
            ragReinitBtn.disabled = true;
            ragToggleBtn.disabled = true;
            ragToggleBtn.classList.add('loading');

            fetch('reinitialize_rag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // é‡ç½®å‰ç«¯çŠ¶æ€å¹¶ç½®ä¸ºå¼€å¯
                    ragInitialized = true;
                    ragEnabled = true;
                    updateToolboxStatus();
                    ragLoadingText.textContent = 'çŸ¥è¯†åº“é‡æ–°åˆå§‹åŒ–å®Œæˆï¼';
                } else {
                    throw new Error(data.error || 'çŸ¥è¯†åº“é‡æ–°åˆå§‹åŒ–å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('RAGé‡æ–°åˆå§‹åŒ–é”™è¯¯:', error);
                ragLoadingText.textContent = 'çŸ¥è¯†åº“é‡æ–°åˆå§‹åŒ–å¤±è´¥: ' + error.message;
            })
            .finally(() => {
                ragToggleBtn.classList.remove('loading');
                ragReinitBtn.disabled = false;
                ragToggleBtn.disabled = false;
                setTimeout(() => {
                    ragLoadingModal.style.display = 'none';
                }, 1200);
            });
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        // æ£€æŸ¥è¯­éŸ³åŠŸèƒ½æ”¯æŒæƒ…å†µ
        if (!checkVoiceSupport()) {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ï¼Œç³»ç»ŸåŠŸèƒ½å—é™');
        }
        
        // åˆå§‹åŒ–è¯­éŸ³æŒ‰é’®çŠ¶æ€
        updateVoiceBtn();
        
        // åˆå§‹åŒ–ç³»ç»ŸçŠ¶æ€
        updateSystemStatus(true);
    </script>
</body>
</html>
